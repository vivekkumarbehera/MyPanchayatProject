<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citizen Dashboard | MyPanchayat (Govt of Odisha)</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+Oriya:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root { --gov-blue: #003366; --gov-orange: #ff9933; --light-bg: #f5f5f5; }
        body { font-family: 'Noto Sans Oriya', 'Roboto', sans-serif; background-color: var(--light-bg); }

        .main-header { background: white; padding: 15px 20px; border-bottom: 4px solid var(--gov-orange); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .gov-logo-box { display: flex; align-items: center; gap: 15px; }
        .gov-text h1 { font-size: 1.4rem; font-weight: 700; color: var(--gov-blue); margin: 0; }

        .portal-container { display: flex; min-height: calc(100vh - 100px); }

        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; padding-top: 20px; display: flex; flex-direction: column; }
        .menu-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #eee; transition: 0.2s; color: #444; }
        .menu-item:hover { background: #eef2f6; color: var(--gov-blue); }
        .menu-item.active { background: var(--gov-blue); color: white; border-left: 5px solid var(--gov-orange); }
        .menu-item i { width: 25px; margin-right: 10px; }

        .main-content { flex: 1; padding: 30px; }
        .gov-card { background: white; padding: 20px; border-top: 3px solid var(--gov-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border-radius: 8px; }
        .btn-gov { background-color: var(--gov-blue); color: white; }
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .status-Pending { background: #fff3cd; color: #856404; }
        .status-Resolved { background: #d1e7dd; color: #0f5132; }

        .priority-high { border-left: 5px solid #dc3545; }
        .priority-med { border-left: 5px solid #ffc107; }
        .priority-low { border-left: 5px solid #198754; }

        .recording-pulse { animation: pulse-red 1s infinite; color: white !important; background-color: #dc3545 !important; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<header class="main-header">
    <div class="gov-logo-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fe/Seal_of_Odisha.png/1200px-Seal_of_Odisha.png" height="50" alt="Odisha Seal">
        <div class="gov-text">
            <h1>MyPanchayat</h1>
            <h2 style="font-size: 0.9rem; color: #555;">Citizen Governance Portal</h2>
        </div>
    </div>
</header>

<div class="portal-container">
    <aside class="sidebar">
        <div class="p-3 text-center bg-light m-3 rounded border">
            <img id="userAvatar" src="" class="rounded-circle mb-2" width="50">
            <div id="userNameDisplay" class="fw-bold">Guest</div>
            <div id="userLocationDisplay" class="small text-muted">Odisha</div>
        </div>
        <ul class="list-unstyled m-0">
            <li class="menu-item active" onclick="showTab('dashboard', this)"><i class="fas fa-home"></i> Dashboard</li>
            <li class="menu-item" onclick="showTab('grievance', this)"><i class="fas fa-bullhorn"></i> Submit Grievance</li>
            <li class="menu-item" onclick="showTab('history', this)"><i class="fas fa-history"></i> My Applications</li>
            <li class="menu-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
        </ul>
    </aside>

    <main class="main-content">
        <div id="dashboard" class="content-tab">
            <h2 class="mb-4 text-primary">Public Grievance Feed</h2>
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> Showing issues for: <strong id="currentPanchayatName">All Odisha</strong></div>
            <div id="grievanceList"><p class="text-center text-muted mt-5">Loading complaints...</p></div>
        </div>

        <div id="grievance" class="content-tab" style="display:none;">
            <h2 class="mb-4 text-primary">Lodge a New Complaint</h2>
            <div class="gov-card">
                <form id="complaintForm">
                    <div class="mb-3">
                        <label class="fw-bold">Description of Issue</label>
                        <textarea id="complaintDesc" class="form-control" rows="4" placeholder="Type details here..."></textarea>
                    </div>

                    <div class="mb-3 p-3 border rounded bg-light">
                        <label class="fw-bold d-block mb-2"><i class="fas fa-map-marker-alt"></i> Location Tracking</label>
                        <button type="button" id="getLocationBtn" onclick="getLocation()" class="btn btn-warning btn-sm mb-2">üìç Get My Exact Location</button>
                        <p id="locationStatus" class="small text-danger m-0">Location not captured.</p>
                        <p id="addressDisplay" class="small fw-bold text-primary mt-1" style="display:none;"></p>
                        <input type="hidden" id="latitude"><input type="hidden" id="longitude">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="small fw-bold">Live Photo (Compulsory)</label>
                            <div class="border rounded bg-light text-center p-2">
                                <video id="cameraStream" autoplay playsinline style="width: 100%; max-height: 150px; display: none; background: #000; border-radius: 5px;"></video>
                                <img id="photoPreview" style="width: 100%; max-height: 150px; display: none;" class="rounded">

                                <button type="button" id="startCamBtn" class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="startCamera()">üì∑ Open Camera</button>
                                <button type="button" id="captureBtn" class="btn btn-sm btn-success w-100 mt-2" onclick="takeSnapshot()" style="display: none;">üì∏ Snap Picture</button>
                                <button type="button" id="retakeBtn" class="btn btn-sm btn-warning w-100 mt-2" onclick="retakePhoto()" style="display: none;">üîÑ Retake</button>
                            </div>
                            <canvas id="photoCanvas" style="display: none;"></canvas>
                        </div>

                        <div class="col-md-4">
                            <label class="small fw-bold">Video</label>
                            <input type="file" id="videoInput" class="form-control" accept="video/*">
                        </div>

                        <div class="col-md-4">
                            <label class="small fw-bold">Voice Note</label>
                            <div class="d-flex gap-2">
                                <button type="button" id="recordBtn" class="btn btn-outline-danger w-100" onclick="startRecording()">Record</button>
                                <button type="button" id="stopBtn" class="btn btn-secondary w-100" onclick="stopRecording()" disabled>Stop</button>
                            </div>
                            <div id="audioPreviewContainer" class="mt-2" style="display:none;">
                                <audio id="audioPreview" controls class="w-100" style="height:35px;"></audio>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="deleteAudio()">Delete Recording</button>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-gov w-100 p-2" onclick="openWardModal()">Proceed to Submit</button>
                </form>
            </div>
        </div>

        <div id="history" class="content-tab" style="display:none;">
            <h2 class="mb-4 text-primary">My Application History</h2>
            <div class="gov-card">
                <table class="table table-hover">
                    <thead class="table-dark"><tr><th>ID</th><th>Priority</th><th>Details</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody id="myAppsTable"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="wardModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h5 class="modal-title">Select Ward</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <label class="fw-bold mb-2">Ward Number:</label>
        <select id="modalWard" class="form-select">
            <option value="Ward 1">Ward 1</option><option value="Ward 2">Ward 2</option>
            <option value="Ward 3">Ward 3</option><option value="Ward 4">Ward 4</option>
        </select>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="finalSubmit()">Confirm & Submit</button>
    </div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let audioBlob = null, mediaRecorder, audioChunks = [], wardModalInstance, currentUser = null, currentPanchayatId = null, currentPanchayatName = "Odisha";
    let livePhotoBlob = null;
    let cameraStream = null;
    let gpsAddressString = ""; // NEW: Stores the physical address for verification

    window.onload = function() {
        const modalElem = document.getElementById('wardModal');
        if (modalElem) wardModalInstance = new bootstrap.Modal(modalElem);

        const userJson = localStorage.getItem("loggedInUser");
        if (!userJson || userJson === "undefined") {
            window.location.href = "login.html";
            return;
        }

        try { currentUser = JSON.parse(userJson); }
        catch (e) { window.location.href = "login.html"; return; }

        const pJson = localStorage.getItem("selectedPanchayat");
        if (pJson && pJson !== "undefined") {
            try {
                const p = JSON.parse(pJson);
                currentPanchayatId = p.id || null;
                currentPanchayatName = p.name || "Odisha Village";
            } catch (e) { currentPanchayatName = "Odisha Village"; }
        } else {
            currentPanchayatName = currentUser.panchayatName || currentUser.panchayat || "Odisha Village";
        }

        const nameDisp = document.getElementById("userNameDisplay");
        const locDisp = document.getElementById("userLocationDisplay");
        const pNameDisp = document.getElementById("currentPanchayatName");
        const avatarDisp = document.getElementById("userAvatar");

        if (nameDisp) nameDisp.innerText = currentUser.name || "Citizen";
        if (locDisp) locDisp.innerText = "üìç " + currentPanchayatName;
        if (pNameDisp) pNameDisp.innerText = currentPanchayatName;

        if (avatarDisp) {
            const safeName = currentUser.name || "User";
            avatarDisp.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName)}&background=003366&color=fff`;
        }

        loadPublicGrievances();
        loadMyHistory();
    };

    // üìç GPS & ADDRESS with Geofencing Storage
    function getLocation() {
        const statusText = document.getElementById("locationStatus");
        const addressText = document.getElementById("addressDisplay");
        if (navigator.geolocation) {
            statusText.innerText = "üìç Locating..."; statusText.className = "small text-warning m-0";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                document.getElementById("latitude").value = lat;
                document.getElementById("longitude").value = lon;
                statusText.innerText = "‚úÖ GPS Coordinates Captured"; statusText.className = "small text-success m-0";
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await res.json();
                    if (data.display_name) {
                        gpsAddressString = data.display_name; // Save the real address
                        addressText.innerText = "üè† " + data.display_name;
                        addressText.style.display = "block";
                    }
                } catch (e) { console.log("Address Error"); }
            }, () => { statusText.innerText = "‚ùå GPS Denied"; });
        }
    }

    // üé§ VOICE RECORDING
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                document.getElementById("audioPreview").src = URL.createObjectURL(audioBlob);
                document.getElementById("audioPreviewContainer").style.display = 'block';
                document.getElementById("recordBtn").classList.remove("recording-pulse");
                document.getElementById("recordBtn").innerText = "Record";
                document.getElementById("recordBtn").disabled = false;
                document.getElementById("stopBtn").disabled = true;
            };
            mediaRecorder.start();
            document.getElementById("recordBtn").classList.add("recording-pulse");
            document.getElementById("recordBtn").innerText = "üî¥ Recording...";
            document.getElementById("recordBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;
        } catch (err) { alert("Microphone Denied"); }
    }
    function stopRecording() { if(mediaRecorder) mediaRecorder.stop(); }
    function deleteAudio() { audioBlob = null; document.getElementById("audioPreviewContainer").style.display = 'none'; }

    // üì∑ LIVE CAMERA FUNCTIONS
    async function startCamera() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            const videoEl = document.getElementById('cameraStream');
            videoEl.srcObject = cameraStream;

            videoEl.style.display = 'block';
            document.getElementById('startCamBtn').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'block';
            document.getElementById('photoPreview').style.display = 'none';
        } catch (err) {
            alert("‚ùå Camera access denied! Please allow permissions.");
        }
    }

    function takeSnapshot() {
        const videoEl = document.getElementById('cameraStream');
        const canvas = document.getElementById('photoCanvas');
        const context = canvas.getContext('2d');
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        context.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
            livePhotoBlob = blob;
            const preview = document.getElementById('photoPreview');
            preview.src = URL.createObjectURL(blob);
            preview.style.display = 'block';
            cameraStream.getTracks().forEach(track => track.stop());
            videoEl.style.display = 'none';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'block';
        }, 'image/jpeg');
    }

    function retakePhoto() {
        livePhotoBlob = null;
        document.getElementById('retakeBtn').style.display = 'none';
        startCamera();
    }

    // GEOFENCING VALIDATION
    function openWardModal() {
        // 1. Photo Check
        if (!livePhotoBlob) {
            alert("‚ö†Ô∏è Please snap a live picture! It is compulsory.");
            return;
        }

        // 2. GPS Presence Check
        if (!gpsAddressString) {
            alert("‚ö†Ô∏è You must capture your exact location before submitting.");
            return;
        }

        // 3. Geofencing: Check if GPS address contains the Panchayat Name
        const registeredPanchayat = currentPanchayatName.toLowerCase();
        const physicalAddress = gpsAddressString.toLowerCase();

        // Strict validation: Skip check only if it's the generic default "Odisha"
        if (registeredPanchayat !== "odisha" && registeredPanchayat !== "odisha village") {
            if (!physicalAddress.includes(registeredPanchayat)) {
                alert(`üö´ ACCESS DENIED (Geofencing)\n\nLocation Mismatch!\nYour GPS says you are in: ${gpsAddressString}\n\nYou must be physically inside ${currentPanchayatName} to submit a grievance.`);
                return;
            }
        }

        wardModalInstance.show();
    }

    async function finalSubmit() {
        const formData = new FormData();
        formData.append("citizenName", currentUser.name);
        formData.append("description", document.getElementById("complaintDesc").value);
        formData.append("ward", document.getElementById("modalWard").value);
        formData.append("userId", currentUser.id);

        const lat = document.getElementById("latitude").value;
        const lon = document.getElementById("longitude").value;
        if (lat && lon) {
            formData.append("latitude", lat);
            formData.append("longitude", lon);
        }

        if (currentPanchayatId) formData.append("panchayatId", currentPanchayatId);
        else formData.append("panchayatName", currentPanchayatName);

        if (livePhotoBlob) formData.append("photo", livePhotoBlob, "live_capture.jpg");

        const video = document.getElementById("videoInput").files[0];
        if (video) formData.append("video", video);
        if (audioBlob) formData.append("audio", audioBlob, "voice.mp3");

        try {
            const res = await fetch("http://localhost:8080/api/complaints", {
                method: "POST",
                body: formData
            });

            if (res.ok) {
                alert("‚úÖ Grievance submitted successfully!");
                wardModalInstance.hide();
                location.reload();
            } else {
                alert("‚ùå Submission Failed. Status: " + res.status);
            }
        } catch (e) {
            console.error("Fetch error:", e);
            alert("‚ùå Server Error.");
        }
    }

    // FEED & HISTORY
    function loadPublicGrievances() {
        fetch(`http://localhost:8080/api/complaints?panchayatName=${encodeURIComponent(currentPanchayatName)}`)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById("grievanceList");
                container.innerHTML = "";
                if (!data || data.length === 0) {
                    container.innerHTML = "<p class='text-center text-muted mt-5'>No complaints found.</p>";
                    return;
                }
                data.reverse().forEach(c => {
                    const score = c.urgencyScore || 0;
                    const status = c.status || "Pending";
                    const priorityClass = score > 60 ? 'priority-high' : (score > 30 ? 'priority-med' : 'priority-low');
                    container.innerHTML += `
                    <div class="gov-card p-3 ${priorityClass}">
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-dark">AI Priority: ${score.toFixed(0)}%</span>
                            <span class="status-badge status-${status}">${status}</span>
                        </div>
                        <h6 class="mt-2 fw-bold">${c.description || "Voice/Media Complaint"}</h6>
                    </div>`;
                });
            });
    }

    function loadMyHistory() {
        fetch(`http://localhost:8080/api/complaints?userId=${currentUser.id}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("myAppsTable");
                tbody.innerHTML = "";
                data.forEach(c => {
                    const score = c.urgencyScore || 0;
                    tbody.innerHTML += `<tr><td>#${c.id}</td><td class="fw-bold text-primary">${score.toFixed(0)}%</td><td>${c.description ? c.description.substring(0,25) : "Media"}</td><td>üìç Captured</td><td><span class="badge bg-secondary">${c.status || "Pending"}</span></td></tr>`;
                });
            });
    }

    function showTab(id, el) {
        document.querySelectorAll('.content-tab').forEach(d => d.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    function logout() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>
</html>
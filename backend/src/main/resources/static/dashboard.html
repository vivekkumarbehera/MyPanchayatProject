<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citizen Dashboard | MyPanchayat (Govt of Odisha)</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+Oriya:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --gov-blue: #003366;
            --gov-orange: #ff9933;
            --light-bg: #f5f5f5;
        }
        body { font-family: 'Noto Sans Oriya', 'Roboto', sans-serif; background-color: var(--light-bg); }

        /* Layout */
        .main-header { background: white; padding: 15px 20px; border-bottom: 4px solid var(--gov-orange); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .gov-logo-box { display: flex; align-items: center; gap: 15px; }
        .gov-text h1 { font-size: 1.4rem; font-weight: 700; color: var(--gov-blue); margin: 0; }

        .portal-container { display: flex; min-height: calc(100vh - 100px); }

        /* Sidebar */
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; padding-top: 20px; display: flex; flex-direction: column; }
        .menu-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #eee; transition: 0.2s; color: #444; }
        .menu-item:hover { background: #eef2f6; color: var(--gov-blue); }
        .menu-item.active { background: var(--gov-blue); color: white; border-left: 5px solid var(--gov-orange); }
        .menu-item i { width: 25px; margin-right: 10px; }

        /* Content */
        .main-content { flex: 1; padding: 30px; }
        .gov-card { background: white; padding: 20px; border-top: 3px solid var(--gov-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn-gov { background-color: var(--gov-blue); color: white; }
        .btn-gov:hover { background-color: #002244; color: white; }

        /* Recording Animation */
        .recording-active { animation: pulse 1.5s infinite; background-color: #dc3545; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Status Badges */
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .status-Pending { background: #fff3cd; color: #856404; }
        .status-Resolved { background: #d1e7dd; color: #0f5132; }
        .status-Rejected { background: #f8d7da; color: #842029; }
    </style>
</head>
<body>

<header class="main-header">
    <div class="gov-logo-box">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fe/Seal_of_Odisha.png/1200px-Seal_of_Odisha.png" height="50" alt="Odisha Seal">
        <div class="gov-text">
            <h1>MyPanchayat</h1>
            <h2 style="font-size: 0.9rem; color: #555;">Citizen Governance Portal</h2>
        </div>
    </div>
    <div class="d-none d-md-block text-end">
        <div class="fw-bold text-primary">Helpline: 1800-345-6789</div>
    </div>
</header>

<div class="portal-container">
    <aside class="sidebar">
        <div class="p-3 text-center bg-light m-3 rounded border">
            <img id="userAvatar" src="" class="rounded-circle mb-2" width="50">
            <div id="userNameDisplay" class="fw-bold">Guest</div>
            <div id="userLocationDisplay" class="small text-muted">Odisha</div>
        </div>

        <ul class="list-unstyled m-0">
            <li class="menu-item active" onclick="showTab('dashboard', this)"><i class="fas fa-home"></i> Dashboard</li>
            <li class="menu-item" onclick="showTab('grievance', this)"><i class="fas fa-bullhorn"></i> Submit Grievance</li>
            <li class="menu-item" onclick="showTab('history', this)"><i class="fas fa-history"></i> My Applications</li>
            <li class="menu-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
        </ul>
    </aside>

    <main class="main-content">

        <div id="dashboard" class="content-tab">
            <h2 class="mb-4 text-primary">Public Grievance Feed</h2>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Viewing public issues for: <strong id="currentPanchayatName">All Odisha</strong>
            </div>
            <div id="grievanceList">
                <p class="text-center text-muted mt-5">Loading complaints...</p>
            </div>
        </div>

        <div id="grievance" class="content-tab" style="display:none;">
            <h2 class="mb-4 text-primary">Lodge a New Complaint</h2>

            <div class="gov-card">
                <form id="complaintForm">
                    <div class="mb-3">
                        <label class="fw-bold">Description of Issue</label>
                        <textarea id="complaintDesc" class="form-control" rows="4" placeholder="Type details here..."></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="small fw-bold"><i class="fas fa-camera"></i> Photo</label>
                            <input type="file" id="photoInput" class="form-control" accept="image/*">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold"><i class="fas fa-video"></i> Video</label>
                            <input type="file" id="videoInput" class="form-control" accept="video/*">
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold"><i class="fas fa-microphone"></i> Voice Note</label>
                            <div class="d-flex gap-2">
                                <button type="button" id="recordBtn" class="btn btn-outline-danger w-100" onclick="startRecording()">Record</button>
                                <button type="button" id="stopBtn" class="btn btn-secondary w-100" onclick="stopRecording()" disabled>Stop</button>
                            </div>
                            <div id="audioPreviewContainer" class="mt-2" style="display:none;">
                                <audio id="audioPreview" controls class="w-100" style="height:30px;"></audio>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="deleteAudio()">Delete Recording</button>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-gov w-100 p-2" onclick="openWardModal()">Proceed to Submit</button>
                </form>
            </div>
        </div>

        <div id="history" class="content-tab" style="display:none;">
            <h2 class="mb-4 text-primary">My History</h2>
            <div class="gov-card">
                <table class="table table-striped">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody id="myAppsTable">
                    </tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<div class="modal fade" id="wardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Select Ward</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="fw-bold mb-2">Ward Number:</label>
                <select id="modalWard" class="form-select">
                    <option value="Ward 1">Ward 1</option>
                    <option value="Ward 2">Ward 2</option>
                    <option value="Ward 3">Ward 3</option>
                    <option value="Ward 4">Ward 4</option>
                    <option value="Ward 5">Ward 5</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="finalSubmit()">Confirm & Submit</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- GLOBAL VARIABLES ---
    let audioBlob = null;
    let mediaRecorder;
    let audioChunks = [];
    let wardModalInstance;
    let currentUser = null;
    let currentPanchayatId = null;
    let currentPanchayatName = "Odisha";

    // --- 1. INITIALIZATION ---
    window.onload = function() {
        wardModalInstance = new bootstrap.Modal(document.getElementById('wardModal'));

        // A. Get User from LocalStorage
        const userJson = localStorage.getItem("loggedInUser");
        if (!userJson) {
            alert("Please login first.");
            window.location.href = "login.html";
            return;
        }
        currentUser = JSON.parse(userJson);

        // B. Get Selected Panchayat (From Search or User Profile)
        const panchayatJson = localStorage.getItem("selectedPanchayat");
        if (panchayatJson) {
            const p = JSON.parse(panchayatJson);
            currentPanchayatId = p.id;
            currentPanchayatName = p.name;
        } else if (currentUser.panchayat) {
            // Fallback if user is linked directly
            currentPanchayatName = typeof currentUser.panchayat === 'string' ? currentUser.panchayat : currentUser.panchayat.name;
            // Assuming if it's an object it has an ID, otherwise we might be missing the ID (Risk area)
            if(currentUser.panchayat.id) currentPanchayatId = currentUser.panchayat.id;
        }

        // C. Update UI Profile
        document.getElementById("userNameDisplay").innerText = currentUser.name;
        document.getElementById("userLocationDisplay").innerText = "ðŸ“ " + currentPanchayatName;
        document.getElementById("currentPanchayatName").innerText = currentPanchayatName;
        document.getElementById("userAvatar").src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=003366&color=fff`;

        // D. Load Data
        loadPublicGrievances();
        loadMyHistory();
    };

    // --- 2. RECORDING LOGIC ---
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                document.getElementById("audioPreview").src = URL.createObjectURL(audioBlob);
                document.getElementById("audioPreviewContainer").style.display = 'block';
                document.getElementById("recordBtn").classList.remove("recording-active");
                document.getElementById("recordBtn").disabled = false;
                document.getElementById("stopBtn").disabled = true;
            };
            mediaRecorder.start();
            document.getElementById("recordBtn").classList.add("recording-active");
            document.getElementById("recordBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;
        } catch (err) {
            alert("Microphone access denied: " + err);
        }
    }

    function stopRecording() { if(mediaRecorder) mediaRecorder.stop(); }
    function deleteAudio() { audioBlob = null; document.getElementById("audioPreviewContainer").style.display = 'none'; }

    // --- 3. SUBMISSION LOGIC (THE FIX) ---
    function openWardModal() {
        if (!document.getElementById("complaintDesc").value && !audioBlob && !document.getElementById("photoInput").files[0]) {
            alert("Please provide some details (Text, Audio, or Photo).");
            return;
        }
        wardModalInstance.show();
    }

    async function finalSubmit() {
        // âœ… REMOVED the check that blocked you ("if !currentPanchayatId...")

        const formData = new FormData();
        formData.append("citizenName", currentUser.name);
        formData.append("mobileNumber", currentUser.mobileNumber || "9999999999");
        formData.append("description", document.getElementById("complaintDesc").value);
        formData.append("ward", document.getElementById("modalWard").value);
        formData.append("userId", currentUser.id);

        // âœ… LOGIC UPDATE: Send ID if we have it, otherwise send Name
        if (currentPanchayatId) {
            formData.append("panchayatId", currentPanchayatId);
        } else {
            console.log("ID missing, sending Name instead:", currentPanchayatName);
            formData.append("panchayatName", currentPanchayatName);
        }

        // Add files
        const photo = document.getElementById("photoInput").files[0];
        if (photo) formData.append("photo", photo);
        const video = document.getElementById("videoInput").files[0];
        if (video) formData.append("video", video);
        if (audioBlob) formData.append("audio", audioBlob, "voice.mp3");

        try {
            const response = await fetch("http://localhost:8080/api/complaints", {
                method: "POST",
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                alert("âœ… Success: " + result.message);
                wardModalInstance.hide();
                document.getElementById("complaintForm").reset();

                // Refresh Tabs
                loadPublicGrievances();
                loadMyHistory();
            } else {
                const errJson = await response.json(); // Read JSON error if possible
                alert("Submission Failed: " + (errJson.error || "Unknown Error"));
            }
        } catch (error) {
            console.error(error);
            alert("Network Error: Could not reach server.");
        }
    }

    // --- 4. DATA LOADING ---
    function loadPublicGrievances() {
        // Fetches complaints based on Panchayat Name (Fixed in previous step)
        fetch(`http://localhost:8080/api/complaints?panchayatName=${encodeURIComponent(currentPanchayatName)}`)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById("grievanceList");
                container.innerHTML = "";
                if (!data || data.length === 0) {
                    container.innerHTML = "<div class='text-center p-4'>No complaints found for this village.</div>";
                    return;
                }
                data.reverse().forEach(c => { // Show newest first
                    let media = "";
                    if(c.photoUrl) media += '<i class="fas fa-image text-primary me-2"></i>';
                    if(c.audioUrl) media += '<i class="fas fa-microphone text-danger me-2"></i>';

                    const html = `
                        <div class="gov-card p-3">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold">Ward: ${c.ward}</h6>
                                <span class="status-badge status-${c.status}">${c.status}</span>
                            </div>
                            <p class="mb-1 text-muted small">By ${c.citizenName} | ${c.createdDate}</p>
                            <p class="mt-2">${c.description || "<i>Voice/Video Complaint</i>"}</p>
                            <div>${media}</div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            })
            .catch(err => console.error("Load Error:", err));
    }

    function loadMyHistory() {
        // Fetches complaints specific to this User ID
        fetch(`http://localhost:8080/api/complaints?userId=${currentUser.id}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("myAppsTable");
                tbody.innerHTML = "";
                if (!data || data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='4' class='text-center'>No applications submitted yet.</td></tr>";
                    return;
                }
                data.forEach(c => {
                    const row = `
                        <tr>
                            <td>#${c.id}</td>
                            <td>${c.createdDate}</td>
                            <td>${c.description ? c.description.substring(0,20)+"..." : "Media File"}</td>
                            <td><span class="badge bg-secondary">${c.status}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    // --- UI NAVIGATION ---
    function showTab(id, el) {
        document.querySelectorAll('.content-tab').forEach(d => d.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if(el) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
        }
    }

    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }
</script>
<script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,or,hi', // Includes English, Odia, and Hindi
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: false
      }, 'google_translate_element');
    }
</script>
</body>
</html>
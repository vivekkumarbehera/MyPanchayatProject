<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grievance Redressal - MyPanchayat</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }

        .container { max-width: 900px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #d35400; margin: 0; }
        .header p { color: #7f8c8d; }

        /* Form Section */
        .form-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-top: 5px solid #d35400;
        }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box; /* Fixes padding issues */
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #d35400;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { background-color: #e67e22; }

        /* Status Board Section */
        .status-board { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: #7f8c8d; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-resolved { background-color: #d4edda; color: #155724; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üì¢ Jan Sunwai (Grievance Portal)</h1>
        <p>Your Voice, Your Right. Report issues anonymously.</p>
    </div>

    <div class="form-card">
        <h3>üìù File a New Complaint</h3>
        <div class="form-group">
            <label>Your Name (Optional)</label>
            <input type="text" id="citizenName" placeholder="Enter name or leave blank for Anonymous">
        </div>
        <div class="form-group">
            <label>Category</label>
            <select id="category">
                <option value="Water">üö∞ Water Supply</option>
                <option value="Roads">üõ£Ô∏è Road Repair</option>
                <option value="Electricity">üí° Street Lights / Electricity</option>
                <option value="Garbage">üóëÔ∏è Garbage / Sanitation</option>
                <option value="Corruption">üö´ Corruption / Bribe Demand</option>
            </select>
        </div>
        <div class="form-group">
            <label>Ward Number</label>
            <select id="ward">
                <option value="Ward 1">Ward 1</option>
                <option value="Ward 2">Ward 2</option>
                <option value="Ward 3">Ward 3</option>
                <option value="Ward 4">Ward 4</option>
                <option value="Ward 5">Ward 5</option>
            </select>
        </div>
        <div class="form-group" style="margin-top: 15px; margin-bottom: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #ddd;">
            <label>Location Detection (Required for Smart Routing)</label><br>
            <button type="button" id="getLocationBtn" onclick="getLocation()" class="btn btn-warning" style="margin-bottom: 10px;">
                üìç Get My Exact Location
            </button>
            <p id="locationStatus" style="color: red; font-size: 14px; margin: 0;">Location not detected yet. Please click the button.</p>

            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
        </div>
        <div class="form-group">
            <label>Description of Issue</label>
            <textarea id="description" rows="4" placeholder="Describe the problem in detail..."></textarea>
        </div>
        <button onclick="submitComplaint()">üöÄ Submit Complaint</button>
    </div>

    <div class="status-board">
        <div class="status-header">
            <h3>üìä Village Complaint Status</h3>
            <button onclick="loadComplaints()" style="width: auto; padding: 5px 15px; font-size: 14px; background: #95a5a6;">Refresh</button>
        </div>
        <table>
            <thead>
            <tr>
                <th>Category</th>
                <th>Ward</th>
                <th>Date</th>
                <th>Deadline</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody id="complaintTable">
            </tbody>
        </table>
    </div>
</div>

<script>
    function submitComplaint(event) {
       if (event) event.preventDefault(); // Stop page reload

       // Create a "digital envelope" that can hold files and text
       const formData = new FormData();

       // 1. Add Text Data
       formData.append("citizenName", document.getElementById('citizenName').value || "Anonymous");
       formData.append("mobileNumber", "1234567890"); // Add your actual mobile input ID here if you have one
       formData.append("ward", document.getElementById('ward').value);
       formData.append("description", document.getElementById('description').value);
       formData.append("userId", 1); // Replace with actual logged-in User ID

       // 2. Add GPS Data
       const lat = document.getElementById('latitude').value;
       const lon = document.getElementById('longitude').value;
       if (lat && lon) {
           formData.append("latitude", lat);
           formData.append("longitude", lon);
       }

       // 3. Add Files (If you have file inputs in your HTML, use their IDs. If not, ignore this part)
       const photoInput = document.getElementById('photo');
       if (photoInput && photoInput.files.length > 0) {
           formData.append("photo", photoInput.files[0]);
       }

       // Send it to the Smart Controller we built in Step 4!
       fetch('/api/complaints', { // Notice: No '/add' here!
           method: 'POST',
           body: formData // No headers needed, browser handles FormData automatically
       })
       .then(response => {
           if (!response.ok) throw new Error("Server rejected the request");
           return response.json();
       })
       .then(data => {
           alert(data.message || 'Complaint Submitted Successfully!');
           location.reload();
       })
       .catch(error => console.error('Error submitting:', error));
   }
       // --- NEW GPS FUNCTION ---
   function getLocation() {
       const statusText = document.getElementById("locationStatus");
       const latInput = document.getElementById("latitude");
       const lonInput = document.getElementById("longitude");

       if (navigator.geolocation) {
           statusText.innerText = "Locating... Please wait.";
           statusText.style.color = "orange";

           navigator.geolocation.getCurrentPosition(
               function(position) {
                   // Success! Fill the hidden fields
                   latInput.value = position.coords.latitude;
                   lonInput.value = position.coords.longitude;

                   statusText.innerText = "‚úÖ Location captured! (" + position.coords.latitude.toFixed(4) + ", " + position.coords.longitude.toFixed(4) + ")";
                   statusText.style.color = "green";
               },
               function(error) {
                   // User denied permission or error occurred
                   statusText.innerText = "‚ùå Location access denied. Please allow GPS.";
                   statusText.style.color = "red";
               },
               { enableHighAccuracy: true }
           );
       } else {
           statusText.innerText = "Geolocation is not supported by your browser.";
       }
   }

       // 2. Function to Load Data
       function loadComplaints() {
           fetch('/api/complaints')
           .then(response => response.json())
           .then(data => {
               const table = document.getElementById('complaintTable');
               table.innerHTML = ''; // Clear existing

               // Sort by latest first
               data.reverse();

               data.forEach(c => {
                   const statusClass = c.status === 'RESOLVED' ? 'status-resolved' : 'status-pending';
                   const row = `
                       <tr>
                           <td><strong>${c.category}</strong><br><small style="color:#777">${c.description.substring(0,30)}...</small></td>
                           <td>${c.ward}</td>
                           <td>${c.createdDate}</td>
                           <td style="color:#e74c3c; font-weight:bold;">${c.deadlineDate}</td>
                           <td><span class="status-badge ${statusClass}">${c.status}</span></td>
                       </tr>
                   `;
                   table.innerHTML += row;
               });
           })
           .catch(error => console.error('Error:', error));
       }

       // Load complaints when page opens
       window.onload = loadComplaints;
</script>

</body>
</html>